<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù…Ù†ØµØ© BTEC zone | ØªØ¹Ù„ÙŠÙ… Ø¨Ø±Ù…Ø¬Ø© + Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ + Ø´Ø¨ÙƒØ§Øª</title>

  <!-- SEO -->
  <meta name="description" content="Ù…Ù†ØµØ© BTEC zone Ù„ØªØ¹Ù„ÙŠÙ… ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: Ø¯Ø±ÙˆØ³ Ø¨Ø±Ù…Ø¬Ø© (Python, C#, C++, HTML, Java...) ÙˆØ£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ ÙˆØ´Ø¨ÙƒØ§ØªØŒ Ù…Ø¹ Ù…Ù‡Ù…Ø§Øª ÙˆÙ…Ù„ÙØ§Øª ÙˆØ¨Ø­Ø« Ø³Ø±ÙŠØ¹ ÙˆÙ…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ."/>
  <meta name="keywords" content="Ù…Ù†ØµØ© Ø¨ØªÙƒ Ø²ÙˆÙ†, BTEC zone, Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… Ø¨Ø±Ù…Ø¬Ø©, Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… Ø¨ØªÙƒ, ØªØ¹Ù„Ù… Ø¨Ø§ÙŠØ«ÙˆÙ†, ØªØ¹Ù„Ù… C#, ØªØ¹Ù„Ù… C++, ØªØ¹Ù„Ù… HTML, ØªØ¹Ù„Ù… Java, Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ, Ø§Ù„Ø´Ø¨ÙƒØ§Øª"/>
  <meta name="robots" content="index,follow"/>

  <!-- Open Graph -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Ù…Ù†ØµØ© BTEC zone"/>
  <meta property="og:description" content="Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: Ø¨Ø±Ù…Ø¬Ø© + Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ + Ø´Ø¨ÙƒØ§Øª + Ù…Ù‡Ù…Ø§Øª."/>
  <meta property="og:locale" content="ar_AR"/>

  <link rel="icon" href="/assets/logo.svg" type="image/svg+xml"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2e;
      --muted:#93a4c7;
      --text:#eaf0ff;
      --brand:#2b7cff;
      --brand2:#00c2ff;
      --ok:#2bd47c;
      --danger:#ff4d6d;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;

      /* Background glows (default) */
      --glow1: 43,124,255;
      --glow2: 0,194,255;
    }

    :root[data-theme="cyber"]{
      /* Cyber theme: subtle green/red glow only */
      --glow1: 43,212,124;
      --glow2: 255,77,109;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:"Tajawal",system-ui,Segoe UI,Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(var(--glow1),.35), transparent 55%),
        radial-gradient(900px 700px at 110% 10%, rgba(var(--glow2),.22), transparent 45%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}

    header{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.65);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}

    .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between}

    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:38px;height:38px}
    .brand b{font-size:18px}

    nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-start}

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); border:none}
    .btn.danger{background:rgba(255,77,109,.14); border:1px solid rgba(255,77,109,.35)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}

    .card{
      background: rgba(18,27,46,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }

    .muted{color:var(--muted)}

    h1{margin:0 0 8px;font-size:28px}
    h2{margin:0 0 8px;font-size:20px}

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.1);
      color:var(--muted);
      font-weight:600;
      font-size:13px;
      white-space:nowrap;
    }

    .track{grid-column: span 4}
    @media (max-width: 900px){ .track{grid-column:span 6} }
    @media (max-width: 620px){ .track{grid-column:span 12} }

    .list{display:flex;flex-direction:column;gap:10px}

    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
    }
    .input:focus{border-color: rgba(43,124,255,.6)}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two{grid-template-columns:1fr}}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background: rgba(0,0,0,.35);
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.1);
      white-space:pre;
      overflow:auto;
    }

    .points{margin:10px 0 0; padding:0 18px}
    .points li{margin:6px 0; color:#dbe6ff}

    .tagOk{color:var(--ok); font-weight:800}
    .tagBad{color:var(--danger); font-weight:800}

    .hint{font-size:12px;color:rgba(255,255,255,.72)}

    .progressBar{
      width:100%;
      height:10px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
    }
    .progressBar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg,var(--brand),var(--brand2));
    }

    footer{
      padding:14px 0;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    .subnav{display:flex;gap:10px;flex-wrap:wrap}

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius: 14px;
    }

    .tiny{font-size:12px}

    .cyberCard{
      background:
        radial-gradient(600px 350px at 0% 0%, rgba(43,212,124,.18), transparent 55%),
        radial-gradient(600px 350px at 100% 0%, rgba(255,77,109,.14), transparent 55%),
        rgba(18,27,46,.92);
      border:1px solid rgba(43,212,124,.18);
    }

    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .resultTitle{font-weight:800}

    mark{
      background: rgba(0,194,255,.18);
      color: var(--text);
      padding: 0 2px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" onclick="go('#/')" style="cursor:pointer">
        <img src="/assets/logo.svg" alt="BTEC"/>
        <div>
          <b>BTEC zone</b>
          <div class="muted" style="font-size:12px">Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
        </div>
      </div>
      <nav>
        <button class="btn" onclick="go('#/')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn" onclick="go('#/tracks')">Ø§Ù„Ø¯Ø±ÙˆØ³</button>
        <button class="btn" onclick="go('#/tasks')">Ø§Ù„Ù…Ù‡Ù…Ø§Øª</button>
        <button class="btn" onclick="go('#/search')">Ø¨Ø­Ø«</button>
        <button class="btn" onclick="go('#/assistant')">Ù…Ø³Ø§Ø¹Ø¯</button>
        <button class="btn" onclick="go('#/login')" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn primary" onclick="go('#/admin')">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        <span class="pill" id="who" style="display:none"></span>
        <button class="btn danger" id="logoutBtn" style="display:none" onclick="logoutStudent()">Ø®Ø±ÙˆØ¬</button>
      </nav>
    </div>
  </div>
</header>

<main class="wrap" id="app"></main>

<footer id="footer">Â© Ù…Ù†ØµØ© BTEC zone â€” Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ù‡Ø§Ø¡ Ø­Ø¬ÙŠØ¬ Â· <a href="https://instagram.com/btec_zone.2_008" target="_blank" rel="noopener">Instagram @btec_zone.2_008</a></footer>

<script>
  const API = "/api";

  const CREDIT_TEXT = "Â© Ù…Ù†ØµØ© BTEC zone â€” Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ·ÙˆÙŠØ±: Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ù‡Ø§Ø¡ Ø­Ø¬ÙŠØ¬ Â· Instagram @btec_zone.2_008";

  const state = {
    tracks: [],
    lessons: [],
    generations: [],
    tasks: [],
    taskDocs: [],
    token: "",
    adminToken: "",
    me: null,
    progressList: []
  };

  function go(h){ location.hash = h; }
  function qs(sel){ return document.querySelector(sel); }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

  function normalizeText(input){
    return String(input ?? "")
      .toLowerCase()
      .replace(/[\u064B-\u065F\u0670]/g, "") // Ø­Ø±ÙƒØ§Øª
      .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
      .replace(/Ù‰/g, "ÙŠ")
      .replace(/Ø©/g, "Ù‡")
      .replace(/[\u200f\u200e]/g, "")
      .trim();
  }

  function tokenize(q){
    const t = normalizeText(q)
      .replace(/[^\p{L}\p{N}]+/gu, " ")
      .split(/\s+/)
      .filter(w => w.length >= 2);
    // remove duplicates
    return [...new Set(t)];
  }

  function setThemeByTrackId(trackId){
    const theme = (trackId === "cyber") ? "cyber" : "";
    if (theme) document.documentElement.dataset.theme = theme;
    else delete document.documentElement.dataset.theme;
  }

  function iconForTrack(t){
    if (!t) return "";
    if (t.icon) return t.icon;
    const id = (t.id || "").toLowerCase();
    const map = {
      it: "ğŸ’»",
      net: "ğŸŒ",
      cyber: "ğŸ›¡ï¸",
      python: "ğŸ",
      csharp: "â™¯",
      cpp: "â•â•",
      java: "â˜•",
      html: "ğŸ”¤",
      css: "ğŸ¨",
      flutter: "ğŸ“±",
      dart: "ğŸ¯"
    };
    return map[id] || "ğŸ“˜";
  }

  async function apiGet(path, token){
    const r = await fetch(API + path, { headers: token ? {"Authorization":"Bearer "+token} : {} });
    return r.json();
  }
  async function apiPost(path, body, token){
    const r = await fetch(API + path, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...(token ? {"Authorization":"Bearer "+token} : {}) },
      body: JSON.stringify(body || {})
    });
    return r.json();
  }
  async function apiDel(path, token){
    const r = await fetch(API + path, { method:"DELETE", headers: token ? {"Authorization":"Bearer "+token} : {} });
    return r.json();
  }
  async function apiPostForm(path, formData, token){
    const r = await fetch(API + path, {
      method: "POST",
      headers: { ...(token ? {"Authorization":"Bearer "+token} : {}) },
      body: formData
    });
    return r.json();
  }

  async function refreshPublic(){
    const j = await apiGet("/public/state");
    if (!j.ok) throw new Error(j.error || "Ø®Ø·Ø£");
    state.tracks = j.tracks || [];
    state.lessons = j.lessons || [];
    state.generations = j.generations || [];
    state.tasks = j.tasks || [];
    state.taskDocs = j.taskDocs || [];
  }

  async function refreshStudent(){
    state.me = null;
    state.progressList = [];
    if (!state.token) return;
    const me = await apiGet("/student/me", state.token).catch(()=>null);
    if (me && me.ok) state.me = me;
    const pl = await apiGet("/student/progress/list", state.token).catch(()=>null);
    if (pl && pl.ok) state.progressList = pl.progress || [];
  }

  function updateNav(){
    const who = qs("#who");
    const logoutBtn = qs("#logoutBtn");
    const loginBtn = qs("#loginBtn");

    if (state.me?.ok && state.me.me){
      who.style.display = "inline-flex";
      logoutBtn.style.display = "inline-flex";
      loginBtn.style.display = "none";
      who.textContent = `Ø·Ø§Ù„Ø¨: ${state.me.me.username || state.me.me.email || "Ø­Ø³Ø§Ø¨"}`;
    } else {
      who.style.display = "none";
      logoutBtn.style.display = "none";
      loginBtn.style.display = "inline-flex";
    }
  }

  function logoutStudent(){
    state.token = "";
    state.me = null;
    state.progressList = [];
    localStorage.removeItem("BTEC_STU_TOKEN");
    updateNav();
    go("#/");
  }

  function trackLessons(trackId){
    return state.lessons.filter(l => l.track_id === trackId);
  }

  function generationNameById(id){
    return (state.generations.find(g => Number(g.id) === Number(id))?.name) || "";
  }

  function calcProgressSummary(){
    const total = state.lessons.length;
    const completed = state.progressList.filter(p => p.completed === 1 || p.completed === true).length;
    const percent = total ? Math.round((completed / total) * 100) : 0;
    return { total, completed, percent };
  }

  function getHash(){ return location.hash || "#/"; }

  function route(){
    const h = getHash().replace(/^#/, "");
    const [p] = h.split("?");
    const parts = p.split("/").filter(Boolean);

    if (parts.length === 0) return renderHome();
    if (parts[0] === "tracks") return renderTracks();
    if (parts[0] === "track" && parts[1]) return renderTrack(parts[1]);
    if (parts[0] === "lesson" && parts[1]) return renderLesson(parts[1]);
    if (parts[0] === "tasks") return renderTasks();
    if (parts[0] === "task" && parts[1]) return renderTask(Number(parts[1]));
    if (parts[0] === "search") return renderSearch();
    if (parts[0] === "login") return renderLogin();
    if (parts[0] === "admin") return renderAdmin();
    if (parts[0] === "assistant") return renderAssistant();

    render404();
  }

  // =========================
  // Pages
  // =========================

  function renderHome(){
    setThemeByTrackId("");
    const app = qs("#app");
    const stats = calcProgressSummary();

    // Ø¢Ø®Ø± Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙŠ ØªØ§Ø¨Ø¹Ù‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„)
    const recentLessons = (state.progressList || [])
      .slice(0, 4)
      .map(p => {
        const l = state.lessons.find(x => x.id === p.lesson_id);
        const tr = l ? state.tracks.find(t => t.id === l.track_id) : null;
        return {
          lesson_id: p.lesson_id,
          completed: p.completed === 1 || p.completed === true,
          last_slide_idx: Number(p.last_slide_idx || 0),
          title: l?.title || 'Ø¯Ø±Ø³',
          track: tr?.title || ''
        };
      });

    const latestTasks = (state.tasks || []).slice(0, 6).map(t => {
      const g = generationNameById(t.generation_id);
      return { ...t, gen: g };
    });

    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <span style="background:linear-gradient(90deg,var(--brand),var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent">BTEC zone</span></h1>
            <div class="muted">Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
            <div style="height:10px"></div>
            <div class="chip"><span>ğŸ‘·â€â™‚ï¸</span><span>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ <b>Ø¨Ù‡Ø§Ø¡ Ø­Ø¬ÙŠØ¬</b></span></div>
            <div style="height:10px"></div>
            <div class="muted" style="line-height:1.8">
              Ø¯Ø±ÙˆØ³ Ø¨Ø±Ù…Ø¬Ø© (Python, C#, C++, HTML, Javaâ€¦)ØŒ ÙˆØ£Ø³Ø§Ø³ÙŠØ§Øª ITØŒ ÙˆØ´Ø¨ÙƒØ§ØªØŒ ÙˆØ£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ â€”
              Ù…Ø¹ Ù…Ù‡Ù…Ø§Øª ÙˆÙ…Ù„ÙØ§Øª Ù„ÙƒÙ„ Ø¬ÙŠÙ„ØŒ ÙˆØ¨Ø­Ø« Ø³Ø±ÙŠØ¹ØŒ ÙˆÙ…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØ³Ø§Ø¹Ø¯Ùƒ ØªÙÙ‡Ù… ÙˆØªØ­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-start">
            <span class="pill">Ø¯Ø±ÙˆØ³ â€¢ Ù…Ù‡Ù…Ø§Øª â€¢ Ù…Ù„ÙØ§Øª â€¢ Ø¨Ø­Ø« â€¢ Ù…Ø³Ø§Ø¹Ø¯</span>
            ${state.token ? `
              <div class="card" style="background:rgba(255,255,255,.03); min-width:260px">
                <b>ØªÙ‚Ø¯Ù…Ùƒ</b>
                <div class="muted tiny">${stats.completed} / ${stats.total} Ø¯Ø±Ø³ Ù…ÙƒØªÙ…Ù„ (${stats.percent}%)</div>
                <div style="height:10px"></div>
                <div class="progressBar"><div style="width:${stats.percent}%"></div></div>
                <div style="height:10px"></div>
                ${state.me?.summary?.last_progress ? `
                  <button class="btn primary" onclick="go('#/lesson/${esc(state.me.summary.last_progress.lesson_id)}')">Ø§ÙƒÙ…Ù„ Ø¢Ø®Ø± Ø¯Ø±Ø³</button>
                ` : `<div class="muted tiny">Ø§Ø¨Ø¯Ø£ Ø¯Ø±Ø³Ø§Ù‹ ÙˆØ³ÙŠØ¸Ù‡Ø± ØªÙ‚Ø¯Ù…Ùƒ Ù‡Ù†Ø§.</div>`}

                ${recentLessons.length ? `
                  <div style="height:10px"></div>
                  <div class="muted tiny">Ø¢Ø®Ø± Ø¯Ø±ÙˆØ³ ØªØ§Ø¨Ø¹ØªÙ‡Ø§:</div>
                  <div style="height:6px"></div>
                  <div class="list">
                    ${recentLessons.map(r=>`
                      <div class="row card" style="background:rgba(255,255,255,.03)">
                        <div>
                          <div class="resultTitle">${esc(r.title)}</div>
                          <div class="muted tiny">${esc(r.track)} ${r.completed ? 'â€¢ <span class="tagOk">Ù…ÙƒØªÙ…Ù„</span>' : (r.last_slide_idx ? ('â€¢ Ø¢Ø®Ø± Ø´Ø±ÙŠØ­Ø©: ' + (r.last_slide_idx+1)) : '')}</div>
                        </div>
                        <button class="btn" onclick="go('#/lesson/${esc(r.lesson_id)}')">ÙØªØ­</button>
                      </div>
                    `).join('')}
                  </div>
                ` : ``}
              </div>
            ` : `
              <div class="card" style="background:rgba(255,255,255,.03); min-width:260px">
                <b>Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</b>
                <div class="muted tiny">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙƒØ·Ø§Ù„Ø¨ Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙŠ Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§ ÙˆØªÙ‚Ø¯Ù…Ùƒ.</div>
                <div style="height:10px"></div>
                <button class="btn primary" onclick="go('#/login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
              </div>
            `}
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="row">
        <h2 style="margin:0">Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆØ³</h2>
        <div class="subnav">
          <button class="btn" onclick="go('#/tracks')">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³</button>
          <button class="btn" onclick="go('#/assistant')">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</button>
          <button class="btn" onclick="go('#/search')">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid">
        ${state.tracks
          .slice()
          .sort((a,b)=>(a.sort_order||0)-(b.sort_order||0))
          .map(t=>{
            const icon = iconForTrack(t);
            const lessonCount = trackLessons(t.id).length;
            const isCyber = t.id === 'cyber';
            return `
              <div class="card track ${isCyber?'cyberCard':''}" onclick="go('#/track/${esc(t.id)}')" style="cursor:pointer">
                <div class="row">
                  <div>
                    <h2 style="margin:0">${esc(t.title)}</h2>
                    <div class="muted">${esc(t.description||"")}</div>
                  </div>
                  <span class="pill" title="${esc(t.title)}">${esc(icon)}</span>
                </div>
                <div style="height:10px"></div>
                <div class="pill">${lessonCount} Ø¯Ø±Ø³</div>
              </div>
            `;
          }).join("")}
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="row">
          <div>
            <h2 style="margin:0">Ø¢Ø®Ø± Ø§Ù„Ù…Ù‡Ù…Ø§Øª</h2>
            <div class="muted">Ù…Ù„ÙØ§Øª ÙˆÙ…Ù‡Ù…Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¬ÙŠÙ„ (2008/2009/2010...).</div>
          </div>
          <button class="btn" onclick="go('#/tasks')">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ù…Ø§Øª</button>
        </div>
        <div style="height:10px"></div>
        <div class="list">
          ${latestTasks.length ? latestTasks.map(t=>`
            <div class="row card" style="background:rgba(255,255,255,.03)">
              <div>
                <div class="resultTitle">${esc(t.title)}</div>
                <div class="muted tiny">Ø§Ù„Ø¬ÙŠÙ„: ${esc(t.gen || "-")}</div>
              </div>
              <button class="btn primary" onclick="go('#/task/${t.id}')">ÙØªØ­</button>
            </div>
          `).join("") : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</div>`}
        </div>
      </div>
    `;
  }

  function renderTracks(){
    setThemeByTrackId("");
    const app = qs("#app");
    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <h1>Ø§Ù„Ø¯Ø±ÙˆØ³</h1>
            <div class="muted">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø± Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³.</div>
          </div>
          <button class="btn" onclick="go('#/')">Ø±Ø¬ÙˆØ¹</button>
        </div>
      </div>
      <div style="height:14px"></div>
      <div class="grid">
        ${state.tracks
          .slice()
          .sort((a,b)=>(a.sort_order||0)-(b.sort_order||0))
          .map(t=>`
          <div class="card track ${t.id==='cyber'?'cyberCard':''}" onclick="go('#/track/${esc(t.id)}')" style="cursor:pointer">
            <div class="row">
              <div>
                <h2 style="margin:0">${esc(t.title)}</h2>
                <div class="muted">${esc(t.description||"")}</div>
              </div>
              <span class="pill">${esc(iconForTrack(t))}</span>
            </div>
            <div style="height:10px"></div>
            <div class="pill">${trackLessons(t.id).length} Ø¯Ø±Ø³</div>
          </div>
        `).join("")}
      </div>
    `;
  }

  function renderTrack(trackId){
    const t = state.tracks.find(x => x.id === trackId);
    if (!t) return render404();
    setThemeByTrackId(trackId);

    const lessons = trackLessons(trackId)
      .slice()
      .sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));

    const progMap = Object.fromEntries((state.progressList || []).map(p => [p.lesson_id, p]));

    const app = qs("#app");

    app.innerHTML = `
      <div class="card ${trackId==='cyber'?'cyberCard':''}">
        <div class="row">
          <div>
            <h1>${esc(t.title)} <span class="pill" style="margin-inline-start:8px">${esc(iconForTrack(t))}</span></h1>
            <div class="muted">${esc(t.description || "")}</div>
            <div class="hint" style="margin-top:8px">ÙƒÙ„ Ø¯Ø±Ø³ ÙŠÙØªØ­ ÙÙŠ ØµÙØ­Ø© Ø®Ø§ØµØ© Ø¨Ù‡. ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨.</div>
          </div>
          <div class="subnav">
            <button class="btn" onclick="go('#/tracks')">ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</button>
            <button class="btn" onclick="go('#/')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
          <span class="pill">${lessons.length} Ø¯Ø±Ø³</span>
        </div>
        <div style="height:10px"></div>
        <div class="list">
          ${lessons.length ? lessons.map(l=>`
            <div class="card" style="background:rgba(255,255,255,.03); cursor:pointer" onclick="go('#/lesson/${esc(l.id)}')">
              <div class="row">
                <div>
                  <b>${esc(l.title)}</b>
                  <div class="muted" style="margin-top:4px">${esc(l.description||"")}</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  ${l.level ? `<span class="pill" title="Ø¨Ø§Ù‚Ø©/Ù…Ø³ØªÙˆÙ‰">${esc(l.level)}</span>` : ``}
                  ${state.token && progMap[l.id] ? `
                    <span class="pill" title="ØªÙ‚Ø¯Ù…Ùƒ">${(progMap[l.id].completed===1||progMap[l.id].completed===true) ? '<span class="tagOk">Ù…ÙƒØªÙ…Ù„ âœ“</span>' : ('Ø¢Ø®Ø± Ø´Ø±ÙŠØ­Ø©: ' + (Number(progMap[l.id].last_slide_idx||0)+1))}</span>
                  ` : ``}
                  <span class="pill" title="${esc(t.title)}">${esc(iconForTrack(t))}</span>
                </div>
              </div>
            </div>
          `).join("") : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø­Ø§Ù„ÙŠØ§Ù‹. (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</div>`}
        </div>
      </div>
    `;
  }

  async function renderLesson(lessonId){
    const app = qs("#app");
    app.innerHTML = `<div class="card">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³...</div>`;

    const j = await apiGet(`/public/lesson?id=${encodeURIComponent(lessonId)}`);
    if (!j.ok) {
      setThemeByTrackId("");
      app.innerHTML = `<div class="card"><b>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³</b><div class="muted">${esc(j.error||"")}</div></div>`;
      return;
    }

    const { lesson, slides } = j;
    const track = state.tracks.find(t => t.id === lesson.track_id);
    setThemeByTrackId(lesson.track_id);

    // student progress
    let prog = null;
    if (state.token) {
      const pj = await apiGet(`/student/progress?lessonId=${encodeURIComponent(lessonId)}`, state.token).catch(()=>null);
      if (pj && pj.ok) prog = pj.progress;
    }

    let idx = Math.max(0, Math.min((slides||[]).length - 1, (prog?.last_slide_idx ?? 0)));

    const totalSlides = (slides||[]).length || 1;

    function render(){
      const s = (slides||[])[idx] || { title:"", points:[], code:"", notes:"" };

      const isCompleted = !!(prog?.completed);
      const percent = Math.round(((idx+1) / totalSlides) * 100);

      app.innerHTML = `
        <div class="card ${lesson.track_id==='cyber'?'cyberCard':''}">
          <div class="row">
            <div>
              <h1>${esc(lesson.title)}
                ${track ? `<span class="pill" style="margin-inline-start:8px">${esc(iconForTrack(track))} ${esc(track.title)}</span>` : ``}
              </h1>
              <div class="muted">${esc(lesson.description || "")}</div>
              ${lesson.level ? `<div class="muted tiny" style="margin-top:6px">Ø¨Ø§Ù‚Ø©/Ù…Ø³ØªÙˆÙ‰: <b>${esc(lesson.level)}</b></div>` : ``}
            </div>
            <div class="subnav">
              <button class="btn" onclick="go('#/track/${esc(lesson.track_id)}')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ø³Ø§Ø±</button>
              <button class="btn" onclick="go('#/assistant')">Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <span class="pill">${idx+1} / ${slides.length}</span>
            ${state.token ? `<span class="pill">${isCompleted ? '<span class="tagOk">Ù…ÙƒØªÙ…Ù„ âœ“</span>' : '<span class="muted">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</span>'}</span>` : `<span class="pill">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</span>`}
          </div>
          <div style="height:10px"></div>
          <div class="progressBar"><div style="width:${isCompleted?100:percent}%"></div></div>
          <div class="muted tiny" style="margin-top:6px">ØªÙ‚Ø¯Ù… Ø§Ù„Ø´Ø±ÙŠØ­Ø©: ${isCompleted?100:percent}%</div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <div class="row">
            <div>
              <h2 style="margin:0">${esc(s.title || "")}</h2>
              ${s.notes ? `<div class="muted tiny" style="margin-top:6px">${esc(s.notes)}</div>` : ``}
            </div>
            <div class="pill" title="Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù†ØµØ©">${esc(CREDIT_TEXT)}</div>
          </div>

          ${(s.points||[]).length ? `<ul class="points">${(s.points||[]).map(p=>`<li>${esc(p)}</li>`).join("")}</ul>` : `<div class="muted" style="margin-top:10px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙŠØ­Ø©.</div>`}

          ${s.code ? `<div style="height:12px"></div><div class="kbd" dir="ltr">${esc(s.code)}</div>` : ``}

          <div style="height:12px"></div>
          <div class="row">
            <div class="subnav">
              <button class="btn" ${idx===0?'disabled':''} onclick="prevSlide()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
              <button class="btn" ${idx===slides.length-1?'disabled':''} onclick="nextSlide()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div class="subnav">
              ${state.token ? `<button class="btn primary" onclick="markComplete()">ØªØ¹Ù„ÙŠÙ… ÙƒÙ…ÙƒØªÙ…Ù„</button>` : ``}
              ${state.token ? `<button class="btn danger" onclick="resetProgress()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</button>` : ``}
            </div>
          </div>
        </div>
      `;

      window.prevSlide = ()=>{ if (idx>0){ idx--; saveProgress(false); render(); } };
      window.nextSlide = ()=>{ if (idx<slides.length-1){ idx++; saveProgress(false); render(); } };
      window.markComplete = async ()=>{ await saveProgress(true); render(); };
      window.resetProgress = async ()=>{
        idx = 0;
        await saveProgress(false, true);
        render();
      };
    }

    async function saveProgress(setComplete, reset){
      if (!state.token) return;
      const body = { lessonId, lastSlideIdx: idx, completed: setComplete ? 1 : (reset ? 0 : (prog?.completed || 0)) };
      const res = await apiPost("/student/progress", body, state.token);
      if (res.ok) {
        prog = { ...(prog||{}), last_slide_idx: idx, completed: body.completed };
        // refresh summary quick
        await refreshStudent().catch(()=>null);
        updateNav();
      }
    }

    render();
  }

  function renderTasks(){
    setThemeByTrackId("");
    const app = qs("#app");

    const gens = (state.generations || []).slice().sort((a,b)=>Number(b.id)-Number(a.id));

    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <h1>Ø§Ù„Ù…Ù‡Ù…Ø§Øª</h1>
            <div class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙŠÙ„ Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª.</div>
          </div>
          <button class="btn" onclick="go('#/')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
      </div>
      <div style="height:14px"></div>
      <div class="grid">
        ${gens.map(g=>{
          const tasks = state.tasks.filter(t=>Number(t.generation_id)===Number(g.id)).slice(0, 6);
          return `
            <div class="card track">
              <div class="row">
                <b>${esc(g.name)}</b>
                <span class="pill">#${g.id}</span>
              </div>
              <div style="height:10px"></div>
              <div class="list">
                ${tasks.length ? tasks.map(t=>`
                  <button class="btn" onclick="go('#/task/${t.id}')">${esc(t.title)}</button>
                `).join("") : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬ÙŠÙ„.</div>`}
              </div>
            </div>
          `;
        }).join("")}
      </div>

      ${gens.length ? `` : `
        <div style="height:14px"></div>
        <div class="card"><div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¬ÙŠØ§Ù„/Ù…Ù‡Ù…Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)</div></div>
      `}
    `;
  }

  function renderTask(taskId){
    setThemeByTrackId("");
    const t = state.tasks.find(x=>Number(x.id)===Number(taskId));
    const docs = state.taskDocs.filter(d=>Number(d.task_id)===Number(taskId));
    const app = qs("#app");
    if (!t) return render404();

    const genName = generationNameById(t.generation_id);

    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <h1>${esc(t.title)}</h1>
            <div class="muted">Ø§Ù„Ø¬ÙŠÙ„: <b>${esc(genName || "-")}</b></div>
            ${t.body ? `<div class="muted" style="margin-top:8px; line-height:1.8">${esc(t.body)}</div>` : ``}
          </div>
          <div class="subnav">
            <button class="btn" onclick="go('#/tasks')">Ø±Ø¬ÙˆØ¹</button>
            <button class="btn" onclick="go('#/assistant')">Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©</h2>
          <span class="pill">${docs.length} Ù…Ù„Ù</span>
        </div>
        <div style="height:10px"></div>
        <div class="list">
          ${docs.length ? docs.map(d=>`
            <div class="row card" style="background:rgba(255,255,255,.03)">
              <div>
                <b>${esc(d.file_name)}</b>
                <div class="muted tiny" style="direction:ltr">${esc(d.download_url)}</div>
              </div>
              <a class="btn primary" href="${esc(d.download_url)}" target="_blank" rel="noopener">ÙØªØ­ / ØªÙ†Ø²ÙŠÙ„</a>
            </div>
          `).join("") : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯.</div>`}
        </div>
      </div>
    `;
  }

  function highlight(text, terms){
    let out = esc(text);
    for (const t of terms){
      if (t.length < 2) continue;
      // naive highlight: replace first occurrences (case-insensitive like)
      const re = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi");
      out = out.replace(re, (m)=>`<mark>${esc(m)}</mark>`);
    }
    return out;
  }

  function renderSearch(){
    setThemeByTrackId("");
    const app = qs("#app");
    app.innerHTML = `
      <div class="card">
        <h1>Ø¨Ø­Ø«</h1>
        <div class="muted">Ø§ÙƒØªØ¨ Ø£ÙŠ ÙƒÙ„Ù…Ø© ÙˆØ³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ù‡Ù…Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª.</div>
        <div style="height:10px"></div>
        <input class="input" id="q" placeholder="Ù…Ø«Ø§Ù„: python â€” Ø´Ø¨ÙƒØ§Øª â€” Ø£Ù…Ù† â€” HTML â€” Ù…Ù‡Ù…Ø©" oninput="doSearch()"/>
        <div style="height:12px"></div>
        <div id="results" class="list"></div>
      </div>
    `;

    window.doSearch = ()=>{
      const q = qs("#q").value || "";
      const terms = tokenize(q);
      const res = qs("#results");
      if (!terms.length){
        res.innerHTML = `<div class="muted">Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ù„Ø¨Ø­Ø«.</div>`;
        return;
      }

      const hits = [];

      // Tracks
      for (const tr of state.tracks){
        const blob = normalizeText(`${tr.title||""} ${tr.description||""} ${tr.id||""}`);
        let score = 0;
        for (const t of terms) if (blob.includes(t)) score += 3;
        if (score>0) hits.push({ type:"Ù…Ø³Ø§Ø±", title: tr.title, subtitle: tr.description||"", href:`#/track/${tr.id}`, score });
      }

      // Lessons
      for (const l of state.lessons){
        const tr = state.tracks.find(t=>t.id===l.track_id);
        const blob = normalizeText(`${l.title||""} ${l.description||""} ${l.level||""} ${tr?tr.title:""}`);
        let score = 0;
        for (const t of terms) if (blob.includes(t)) score += 5;
        if (score>0) hits.push({ type:"Ø¯Ø±Ø³", title: l.title, subtitle: tr ? tr.title : "", href:`#/lesson/${l.id}`, score });
      }

      // Tasks
      for (const tsk of state.tasks){
        const gen = generationNameById(tsk.generation_id);
        const blob = normalizeText(`${tsk.title||""} ${tsk.body||""} ${gen||""}`);
        let score = 0;
        for (const t of terms) if (blob.includes(t)) score += 4;
        if (score>0) hits.push({ type:"Ù…Ù‡Ù…Ø©", title: tsk.title, subtitle: `Ø§Ù„Ø¬ÙŠÙ„: ${gen||"-"}`, href:`#/task/${tsk.id}`, score });
      }

      // Docs
      for (const d of state.taskDocs){
        const blob = normalizeText(`${d.file_name||""}`);
        let score = 0;
        for (const t of terms) if (blob.includes(t)) score += 2;
        if (score>0) hits.push({ type:"Ù…Ù„Ù", title: d.file_name, subtitle: "Ù…Ù„Ù Ù…Ø±ÙÙ‚ Ù„Ù…Ù‡Ù…Ø©", href:d.download_url, external:true, score });
      }

      hits.sort((a,b)=>b.score-a.score);

      res.innerHTML = hits.length ? `
        <div class="muted tiny">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <b>${hits.length}</b> Ù†ØªÙŠØ¬Ø©.</div>
        <div style="height:8px"></div>
        ${hits.map(h=>`
          <div class="row card" style="background:rgba(255,255,255,.03)">
            <div>
              <span class="pill">${esc(h.type)}</span>
              <div class="resultTitle" style="margin-top:6px">${highlight(h.title, terms)}</div>
              ${h.subtitle ? `<div class="muted tiny">${highlight(h.subtitle, terms)}</div>` : ``}
            </div>
            <a class="btn primary" href="${esc(h.href)}" ${h.external?`target="_blank" rel="noopener"`:""}>ÙØªØ­</a>
          </div>
        `).join("")}
      ` : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ©.</div>`;
    };

    window.doSearch();
  }

  function renderLogin(){
    setThemeByTrackId("");
    const app = qs("#app");
    app.innerHTML = `
      <div class="card">
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <div class="muted">Ø§Ù„Ø·Ø§Ù„Ø¨: Ø§ÙƒØªØ¨ Ø£ÙŠ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ. Ø§Ù„Ø£Ø¯Ù…Ù†: Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….</div>
        <div style="height:14px"></div>

        <div class="two">
          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2>Ø·Ø§Ù„Ø¨</h2>
            <input class="input" id="s_login" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ø§Ù„: student2008)"/>
            <div style="height:8px"></div>
            <input class="input" id="s_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
            <div style="height:10px"></div>
            <div class="subnav">
              <button class="btn primary" onclick="studentLoginAuto()">Ø¯Ø®ÙˆÙ„</button>
              <button class="btn" onclick="studentRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </div>
            <div id="s_msg" class="muted" style="margin-top:10px"></div>
            <div class="hint" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ (Ø¯Ø®ÙˆÙ„).</div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <h2>Ø£Ø¯Ù…Ù†</h2>
            <input class="input" id="a_user" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ (ADMIN_USER)"/>
            <div style="height:8px"></div>
            <input class="input" id="a_pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ADMIN_PASS)"/>
            <div style="height:10px"></div>
            <button class="btn primary" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
            <div id="a_msg" class="muted" style="margin-top:10px"></div>
            <div class="hint" style="margin-top:8px">ÙŠØ¬Ø¨ Ø¶Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudflare (Secrets).</div>
          </div>
        </div>
      </div>
    `;

    window.studentRegister = async ()=>{
      const login = (qs("#s_login").value || "").trim();
      const password = qs("#s_pass").value || "";
      if (!login || !password){ qs("#s_msg").textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."; return; }
      const isEmail = login.includes("@");
      const body = isEmail ? { email: login, password } : { username: login, password };
      const r = await apiPost("/student/register", body);
      qs("#s_msg").textContent = r.ok ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„." : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        state.token = r.token;
        localStorage.setItem("BTEC_STU_TOKEN", r.token);
        await refreshStudent().catch(()=>null);
        updateNav();
        go("#/");
      }
    };

    window.studentLoginAuto = async ()=>{
      const login = (qs("#s_login").value || "").trim();
      const password = qs("#s_pass").value || "";
      if (!login || !password){ qs("#s_msg").textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."; return; }

      // 1) try login
      const r = await apiPost("/student/login", { login, password });
      if (r.ok){
        qs("#s_msg").textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        state.token = r.token;
        localStorage.setItem("BTEC_STU_TOKEN", r.token);
        await refreshStudent().catch(()=>null);
        updateNav();
        go("#/");
        return;
      }

      // 2) auto-register if not exists
      const isEmail = login.includes("@");
      const body = isEmail ? { email: login, password } : { username: login, password };
      const rr = await apiPost("/student/register", body);
      if (rr.ok){
        qs("#s_msg").textContent = "Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø³Ø§Ø¨ â€” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
        state.token = rr.token;
        localStorage.setItem("BTEC_STU_TOKEN", rr.token);
        await refreshStudent().catch(()=>null);
        updateNav();
        go("#/");
        return;
      }

      // if exists but password wrong
      qs("#s_msg").textContent = rr.error || r.error || "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
    };

    window.adminLogin = async ()=>{
      const user = (qs("#a_user").value || "").trim();
      const pass = qs("#a_pass").value || "";
      const r = await apiPost("/admin/login", { user, pass });
      qs("#a_msg").textContent = r.ok ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†." : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        state.adminToken = r.token;
        localStorage.setItem("BTEC_ADM_TOKEN", r.token);
        go("#/admin");
      }
    };
  }

  function renderAdmin(){
    setThemeByTrackId("");
    const app = qs("#app");

    if (!state.adminToken){
      app.innerHTML = `
        <div class="card">
          <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØ­ØªØ§Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.</b>
          <div class="muted" style="margin-top:6px">Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø«Ù… Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†.</div>
          <div style="height:10px"></div>
          <button class="btn primary" onclick="go('#/login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
      `;
      return;
    }

    const tracksSorted = state.tracks.slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const gensSorted = state.generations.slice().sort((a,b)=>Number(b.id)-Number(a.id));
    const tasksSorted = state.tasks.slice().sort((a,b)=>Number(b.id)-Number(a.id)).slice(0, 250);

    app.innerHTML = `
      <div class="card">
        <div class="row">
          <div>
            <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <div class="muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ù‡Ù…Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª.</div>
            <div class="muted tiny" style="margin-top:6px">${esc(CREDIT_TEXT)}</div>
          </div>
          <button class="btn danger" onclick="logoutAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="two">
        <div class="card">
          <h2>Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
          <div class="muted">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù Ø¯Ø±Ø³.</div>
          <div class="hr"></div>

          <label class="muted tiny">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø±</label>
          <select class="input" id="trackSel">
            ${tracksSorted.map(t=>`<option value="${esc(t.id)}">${esc(iconForTrack(t))} ${esc(t.title)}</option>`).join("")}
          </select>

          <div style="height:8px"></div>
          <label class="muted tiny">Ø§Ø®ØªØ± Ø¯Ø±Ø³ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ "Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯")</label>
          <select class="input" id="lessonSel"></select>

          <div style="height:8px"></div>
          <input class="input" id="lessonTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³"/>

          <div style="height:8px"></div>
          <input class="input" id="lessonLevel" placeholder="Ø¨Ø§Ù‚Ø© / Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ (Ù…Ø«Ø§Ù„: Ù…Ø¨ØªØ¯Ø¦ / Ù…ØªÙˆØ³Ø· / Ù…ØªÙ‚Ø¯Ù…)"/>

          <div style="height:8px"></div>
          <textarea class="input" id="lessonDesc" rows="3" style="resize:vertical" placeholder="Ø´Ø±Ø­ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø¯Ø±Ø³"></textarea>

          <div style="height:8px"></div>
          <textarea class="input" id="slidesJson" rows="10" style="resize:vertical" placeholder='Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø¨ØµÙŠØºØ© JSON (Ù…Ø«Ø§Ù„):
[
  {"title":"Ù…Ù‚Ø¯Ù…Ø©","points":["..."],"code":""},
  {"title":"Ù…Ø«Ø§Ù„","points":["..."],"code":"print(123)"}
]'></textarea>

          <div style="height:10px"></div>
          <div class="subnav">
            <button class="btn primary" onclick="saveLesson()">Ø­ÙØ¸</button>
            <button class="btn" onclick="newLesson()">Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn danger" onclick="deleteLesson()">Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³</button>
          </div>

          <div id="admMsg" class="muted" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h2>Ø§Ù„Ù…Ù‡Ù…Ø§Øª + Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
          <div class="muted">Ø¥Ø¶Ø§ÙØ© Ø¬ÙŠÙ„ (2008/2009/2010â€¦) Ø«Ù… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© Ø«Ù… Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙ‡Ø§.</div>
          <div class="hr"></div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <b>1) Ø¥Ø¶Ø§ÙØ© Ø¬ÙŠÙ„</b>
            <div style="height:8px"></div>
            <input class="input" id="genName" placeholder="Ù…Ø«Ø§Ù„: 2008 Ø£Ùˆ 2009 Ø£Ùˆ 2010"/>
            <div style="height:10px"></div>
            <button class="btn primary" onclick="createGen()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙŠÙ„</button>
            <div id="genMsg" class="muted" style="margin-top:10px"></div>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <b>2) Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø©</b>
            <div style="height:8px"></div>
            <select class="input" id="genSel">
              ${gensSorted.map(g=>`<option value="${g.id}">${esc(g.name)} (#${g.id})</option>`).join("")}
            </select>
            <div style="height:8px"></div>
            <input class="input" id="taskTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©"/>
            <div style="height:8px"></div>
            <textarea class="input" id="taskBody" rows="3" style="resize:vertical" placeholder="ÙˆØµÙ/Ø´Ø±Ø­ Ø§Ù„Ù…Ù‡Ù…Ø©"></textarea>
            <div style="height:10px"></div>
            <div class="subnav">
              <button class="btn primary" onclick="createTask()">Ø¥Ù†Ø´Ø§Ø¡</button>
            </div>
            <div id="taskMsg" class="muted" style="margin-top:10px"></div>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="background:rgba(255,255,255,.03)">
            <b>3) Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ù‡Ù…Ø©</b>
            <div class="muted tiny" style="margin-top:6px">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØªÙ… Ø¥Ù„Ù‰ GitHub (ÙŠÙ„Ø²Ù… Ø¶Ø¨Ø· Secrets Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ GitHub).</div>
            <div style="height:8px"></div>
            <select class="input" id="taskSel">
              ${tasksSorted.map(t=>`<option value="${t.id}">#${t.id} â€” ${esc(t.title)}</option>`).join("")}
            </select>
            <div style="height:8px"></div>
            <input class="input" id="fileInp" type="file" multiple/>
            <div style="height:10px"></div>
            <div class="subnav">
              <button class="btn primary" onclick="uploadDocs()">Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
              <button class="btn danger" onclick="deleteTask()">Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            </div>
            <div id="upMsg" class="muted" style="margin-top:10px"></div>
          </div>

        </div>
      </div>
    `;

    // Fill lesson selector
    window.fillLessons = async ()=>{
      const trackId = qs("#trackSel").value;
      const lessons = state.lessons.filter(l=>l.track_id===trackId).slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      const sel = qs("#lessonSel");
      sel.innerHTML = `<option value="">(Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯)</option>` + lessons.map(l=>`<option value="${esc(l.id)}">${esc(l.title)}</option>`).join("");
      // reset fields
      qs("#lessonTitle").value = "";
      qs("#lessonLevel").value = "";
      qs("#lessonDesc").value = "";
      qs("#slidesJson").value = "[]";
    };

    window.loadLesson = async ()=>{
      const id = qs("#lessonSel").value;
      if (!id){
        qs("#lessonTitle").value = "";
        qs("#lessonLevel").value = "";
        qs("#lessonDesc").value = "";
        qs("#slidesJson").value = "[]";
        return;
      }
      const meta = state.lessons.find(l=>l.id===id);
      if (meta){
        qs("#lessonTitle").value = meta.title || "";
        qs("#lessonLevel").value = meta.level || "";
        qs("#lessonDesc").value = meta.description || "";
      }
      const full = await apiGet(`/public/lesson?id=${encodeURIComponent(id)}`);
      if (full && full.ok){
        const slides = (full.slides || []).map(s=>({
          title: s.title,
          points: s.points || [],
          code: s.code || "",
          notes: s.notes || ""
        }));
        qs("#slidesJson").value = JSON.stringify(slides, null, 2);
      }
    };

    qs("#trackSel").addEventListener("change", ()=>{ fillLessons(); });
    qs("#lessonSel").addEventListener("change", ()=>{ loadLesson(); });

    // initial
    fillLessons();

    window.logoutAdmin = ()=>{
      state.adminToken = "";
      localStorage.removeItem("BTEC_ADM_TOKEN");
      go("#/");
    };

    window.newLesson = ()=>{
      qs("#lessonSel").value = "";
      loadLesson();
      qs("#admMsg").textContent = "Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯.";
    };

    window.saveLesson = async ()=>{
      const track_id = qs("#trackSel").value;
      const id = qs("#lessonSel").value || undefined;
      const title = (qs("#lessonTitle").value || "").trim();
      const level = (qs("#lessonLevel").value || "").trim();
      const description = (qs("#lessonDesc").value || "").trim();

      if (!title){ qs("#admMsg").textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³."; return; }

      let slides = [];
      try{
        slides = JSON.parse(qs("#slidesJson").value || "[]");
        if (!Array.isArray(slides)) throw new Error("not array");
      }catch(e){
        qs("#admMsg").textContent = "ØµÙŠØºØ© Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return;
      }

      const r = await apiPost("/admin/lessons", { id, track_id, title, level, description, slides }, state.adminToken);
      qs("#admMsg").textContent = r.ok ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³." : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        await refreshPublic().catch(()=>null);
        fillLessons();
        qs("#lessonSel").value = r.id;
        await loadLesson();
      }
    };

    window.deleteLesson = async ()=>{
      const id = qs("#lessonSel").value;
      if (!id){ qs("#admMsg").textContent = "Ø§Ø®ØªØ± Ø¯Ø±Ø³Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹."; return; }
      if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø£ÙŠØ¶Ø§Ù‹.")) return;
      const r = await apiDel(`/admin/lessons?id=${encodeURIComponent(id)}`, state.adminToken);
      qs("#admMsg").textContent = r.ok ? "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³." : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        await refreshPublic().catch(()=>null);
        fillLessons();
      }
    };

    window.createGen = async ()=>{
      const name = (qs("#genName").value || "").trim();
      if (!name){ qs("#genMsg").textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¬ÙŠÙ„."; return; }
      const r = await apiPost("/admin/generations", { name }, state.adminToken);
      qs("#genMsg").textContent = r.ok ? `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬ÙŠÙ„ (#${r.id}).` : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        qs("#genName").value = "";
        await refreshPublic().catch(()=>null);
        go("#/admin"); // refresh UI
      }
    };

    window.createTask = async ()=>{
      const generation_id = Number(qs("#genSel").value);
      const title = (qs("#taskTitle").value || "").trim();
      const body = (qs("#taskBody").value || "").trim();
      if (!generation_id || !title){ qs("#taskMsg").textContent = "Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙŠÙ„ ÙˆØ§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©."; return; }
      const r = await apiPost("/admin/tasks", { generation_id, title, body }, state.adminToken);
      qs("#taskMsg").textContent = r.ok ? `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© (#${r.id}).` : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        qs("#taskTitle").value = "";
        qs("#taskBody").value = "";
        await refreshPublic().catch(()=>null);
        go("#/admin");
      }
    };

    window.uploadDocs = async ()=>{
      const taskId = qs("#taskSel").value;
      const files = Array.from(qs("#fileInp").files || []);
      if (!taskId){ qs("#upMsg").textContent = "Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø©."; return; }
      if (!files.length){ qs("#upMsg").textContent = "Ø§Ø®ØªØ± Ù…Ù„Ù/Ù…Ù„ÙØ§Øª."; return; }

      let okCount = 0;
      for (const f of files){
        const fd = new FormData();
        fd.append("file", f);
        const r = await apiPostForm(`/admin/task-docs/upload?taskId=${encodeURIComponent(taskId)}`, fd, state.adminToken);
        if (r.ok) okCount++;
      }
      qs("#upMsg").textContent = `ØªÙ… Ø±ÙØ¹ ${okCount} / ${files.length} Ù…Ù„Ù.`;
      await refreshPublic().catch(()=>null);
    };

    window.deleteTask = async ()=>{
      const taskId = qs("#taskSel").value;
      if (!taskId){ qs("#upMsg").textContent = "Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø©."; return; }
      if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙˆÙ„ÙƒÙ† Ù…Ù„ÙØ§Øª GitHub ØªØ¨Ù‚Ù‰ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©).")) return;
      const r = await apiDel(`/admin/tasks?id=${encodeURIComponent(taskId)}`, state.adminToken);
      qs("#upMsg").textContent = r.ok ? "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©." : (r.error || "Ø®Ø·Ø£");
      if (r.ok){
        await refreshPublic().catch(()=>null);
        go("#/admin");
      }
    };
  }

  function renderAssistant(){
    setThemeByTrackId("");
    const app = qs("#app");

    app.innerHTML = `
      <div class="grid" style="grid-template-columns: 1.2fr .8fr;">
        <div class="card">
          <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ù‡Ù…Ø§Øª</h1>
          <div class="muted">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ. Ø³Ø£Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ù‡Ù…Ø§Øª Ø«Ù… Ø£Ø¬ÙŠØ¨Ùƒ Ø¨Ø´Ø±Ø­ ÙˆØ§Ø¶Ø­ ÙˆØ®Ø·ÙˆØ§Øª ÙˆØ£Ù…Ø«Ù„Ø©.</div>
          <div class="hint" style="margin-top:8px">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ) â€” ÙˆÙ‚Ø¯ ÙŠØ­ØªØ§Ø¬ ÙˆÙ‚Øª Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ ØµØºÙŠØ±.</div>

          <div style="height:10px"></div>
          <textarea class="input" id="ask" rows="4" style="resize:vertical" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø´Ø±Ø­ if/else ÙÙŠ Python. Ø£Ùˆ: ÙƒÙŠÙ Ø£Ø­Ù„ Ù…Ù‡Ù…Ø© Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø±Ù‚Ù… 2ØŸ"></textarea>

          <div style="height:10px"></div>
          <div class="subnav">
            <button class="btn primary" onclick="assistRun()">Ø§Ø³Ø£Ù„</button>
            <button class="btn" onclick="assistClear()">Ù…Ø³Ø­</button>
          </div>

          <div style="height:12px"></div>
          <div id="aStatus" class="muted tiny"></div>

          <div style="height:12px"></div>
          <div id="aAnswer" class="card" style="background:rgba(255,255,255,.03)"></div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px">Ù…ØµØ§Ø¯Ø± Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©</h2>
          <div class="muted tiny">Ø§Ù„Ø¯Ø±ÙˆØ³/Ø§Ù„Ù…Ù‡Ù…Ø§Øª Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ø³Ø¤Ø§Ù„Ùƒ</div>
          <div style="height:10px"></div>
          <div id="aRes" class="list"></div>
        </div>
      </div>
    `;

    window.assistClear = ()=>{
      qs("#ask").value = "";
      qs("#aAnswer").innerHTML = "";
      qs("#aRes").innerHTML = "";
      qs("#aStatus").textContent = "";
    };

    let engine = null;
    let engineReady = false;

    async function ensureEngine(){
      if (engineReady) return true;
      const st = qs("#aStatus");
      try{
        st.textContent = "Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯â€¦";
        const webllm = await import("https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/+esm");
        engine = await webllm.CreateMLCEngine(
          "Llama-3.2-1B-Instruct-q4f16_1",
          { initProgressCallback: (p)=>{ st.textContent = `ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯: ${Math.round((p.progress||0)*100)}%`; } }
        );
        engineReady = true;
        st.textContent = "";
        return true;
      }catch(e){
        st.textContent = "";
        engine = null;
        engineReady = false;
        return false;
      }
    }

    function scoreTerms(terms, blob){
      if (!terms.length || !blob) return 0;
      const b = normalizeText(blob);
      let s = 0;
      for (const t of terms){
        if (b.includes(t)) s += 3;
      }
      return s;
    }

    async function fetchLessonBundle(id){
      const j = await apiGet(`/public/lesson?id=${encodeURIComponent(id)}`);
      if (!j.ok) return null;
      return { lesson: j.lesson, slides: j.slides || [] };
    }

    function extractLessonText(bundle){
      const { lesson, slides } = bundle;
      const parts = [];
      parts.push(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${lesson.title}`);
      if (lesson.description) parts.push(`Ø§Ù„ÙˆØµÙ: ${lesson.description}`);
      if (lesson.level) parts.push(`Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${lesson.level}`);
      for (const s of (slides||[]).slice(0, 20)){
        parts.push(`\nØ´Ø±ÙŠØ­Ø© ${s.idx+1}: ${s.title||""}`);
        const pts = (s.points||[]).slice(0, 8);
        if (pts.length) parts.push("Ù†Ù‚Ø§Ø·: " + pts.join("ØŒ "));
        if (s.code) parts.push("ÙƒÙˆØ¯:\n" + s.code);
      }
      return parts.join("\n");
    }

    function renderSources(lessonsRanked, tasksRanked){
      const out = qs("#aRes");
      const blocks = [];

      if (lessonsRanked.length){
        blocks.push(`<div class="muted tiny">Ø¯Ø±ÙˆØ³</div>`);
        blocks.push(lessonsRanked.map(x=>`
          <div class="row card" style="background:rgba(255,255,255,.03)">
            <div>
              <b>${esc(x.title)}</b>
              <div class="muted tiny">${esc(x.trackTitle||"")}</div>
            </div>
            <button class="btn primary" onclick="go('#/lesson/${esc(x.id)}')">ÙØªØ­</button>
          </div>
        `).join(""));
      }

      if (tasksRanked.length){
        blocks.push(`<div style="height:10px"></div><div class="muted tiny">Ù…Ù‡Ù…Ø§Øª</div>`);
        blocks.push(tasksRanked.map(t=>`
          <div class="row card" style="background:rgba(255,255,255,.03)">
            <div>
              <b>${esc(t.title||("Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… "+t.id))}</b>
              <div class="muted tiny">Ø§Ù„Ø¬ÙŠÙ„: ${esc(t.gen||"-")}</div>
            </div>
            <button class="btn" onclick="go('#/task/${esc(t.id)}')">ÙØªØ­</button>
          </div>
        `).join(""));
      }

      out.innerHTML = blocks.length ? blocks.join("") : `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ù‚Ø±ÙŠØ¨Ø©. Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø§Øª Ø£ÙˆØ¶Ø­.</div>`;
    }

    function fallbackAnswer(q, context){
      return `
        <div class="muted tiny">${esc(CREDIT_TEXT)}</div>
        <div style="height:8px"></div>
        <b>Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†ØµØ©</b>
        <div style="height:10px"></div>
        <div class="muted tiny">Ø³Ø¤Ø§Ù„Ùƒ:</div>
        <div style="white-space:pre-wrap; line-height:1.7">${esc(q)}</div>
        <div style="height:10px"></div>
        <div class="muted tiny">Ù…Ù‚ØªØ·Ù Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø±Ø¨:</div>
        <pre style="white-space:pre-wrap; line-height:1.7">${esc(context || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ§Ù‚ ÙƒØ§ÙÙ.")}</pre>
        <div class="muted tiny">Ù„Ùˆ ÙƒØªØ¨Øª Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø³ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ø¯Ù‚Ø© (Ø£Ùˆ Ø£Ø±ÙÙ‚Øª ÙƒÙˆØ¯Ùƒ)ØŒ Ø£Ù‚Ø¯Ø± Ø£Ø¹Ø·ÙŠÙƒ Ø¬ÙˆØ§Ø¨ Ø£Ø¯Ù‚.</div>
      `;
    }

    window.assistRun = async ()=>{
      const q = (qs("#ask").value || "").trim();
      const ans = qs("#aAnswer");
      ans.innerHTML = "";

      if (!q){
        qs("#aRes").innerHTML = `<div class="muted">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.</div>`;
        return;
      }

      const terms = tokenize(q);

      const trackById = Object.fromEntries(state.tracks.map(t=>[t.id, t]));

      const lessonsRanked = state.lessons
        .map(l=>{
          const tr = trackById[l.track_id];
          const blob = `${l.title||""} ${l.description||""} ${l.level||""} ${tr?tr.title:""}`;
          return {
            id: l.id,
            title: l.title,
            trackTitle: tr?tr.title:"",
            score: scoreTerms(terms, blob)
          };
        })
        .filter(x=>x.score>0)
        .sort((a,b)=>b.score-a.score)
        .slice(0, 4);

      const tasksRanked = (state.tasks||[])
        .map(t=>{
          const gen = generationNameById(t.generation_id);
          const blob = `${t.title||""} ${t.body||""} ${gen||""}`;
          return {
            id: t.id,
            title: t.title,
            body: t.body||"",
            gen,
            score: scoreTerms(terms, blob)
          };
        })
        .filter(x=>x.score>0)
        .sort((a,b)=>b.score-a.score)
        .slice(0, 4);

      renderSources(lessonsRanked, tasksRanked);

      // Collect context from top lessons + top task
      const bundles = [];
      for (const l of lessonsRanked.slice(0, 2)){
        const b = await fetchLessonBundle(l.id);
        if (b) bundles.push(b);
      }

      let context = bundles.map(extractLessonText).join("\n\n---\n\n");
      if (tasksRanked[0]){
        context += `\n\n---\n\nÙ…Ù‡Ù…Ø© Ù‚Ø±ÙŠØ¨Ø©: ${tasksRanked[0].title}\nØ§Ù„ÙˆØµÙ: ${tasksRanked[0].body}`;
      }

      const ok = await ensureEngine();
      if (ok && engine){
        try{
          const system = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ù†ØµØ© BTEC zone. Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ ÙˆØ§Ø¶Ø­ ÙˆÙ…Ù†Ø¸Ù….\n\nÙ‚ÙˆØ§Ø¹Ø¯ Ù…Ù‡Ù…Ø©:\n- Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø±ÙÙ‚ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†.\n- Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø­Ù„ Ù…Ù‡Ù…Ø©: Ø£Ø¹Ø·Ù Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ Ø«Ù… Ù…Ø«Ø§Ù„/ÙƒÙˆØ¯.\n- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù…Ù‘Ø§Ù‹: Ø§Ø´Ø±Ø­ Ø§Ù„ÙÙƒØ±Ø© Ø«Ù… Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ·.\n- Ø¥Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚ ØºÙŠØ± ÙƒØ§ÙÙ: Ø§Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­Ø§Ù‹ Ù…Ø­Ø¯Ø¯Ø§Ù‹.`;

          const user = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${q}\n\nØ³ÙŠØ§Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©:\n${context}`;

          const reply = await engine.chat.completions.create({
            messages: [
              { role:"system", content: system },
              { role:"user", content: user }
            ],
            temperature: 0.2,
            max_tokens: 520
          });

          const text = reply.choices?.[0]?.message?.content || "";
          ans.innerHTML = `
            <div class="muted tiny">${esc(CREDIT_TEXT)}</div>
            <div style="height:10px"></div>
            <div style="white-space:pre-wrap; line-height:1.9">${esc(text)}</div>
          `;
          return;
        }catch(e){
          // fallback below
        }
      }

      ans.innerHTML = fallbackAnswer(q, context);
    };
  }

  function render404(){
    setThemeByTrackId("");
    qs("#app").innerHTML = `
      <div class="card">
        <b>Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</b>
        <div class="muted" style="margin-top:6px">Ø§Ø±Ø¬Ø¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</div>
        <div style="height:10px"></div>
        <button class="btn primary" onclick="go('#/')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    `;
  }

  // =========================
  // Boot
  // =========================

  (async function boot(){
    state.token = localStorage.getItem("BTEC_STU_TOKEN") || "";
    state.adminToken = localStorage.getItem("BTEC_ADM_TOKEN") || "";

    try { await refreshPublic(); } catch(e) {}
    try { await refreshStudent(); } catch(e) {}

    updateNav();

    route();
    window.addEventListener("hashchange", route);
  })();
</script>

<!-- Structured data (basic) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "EducationalOrganization",
  "name": "BTEC zone",
  "description": "Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ… ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: Ø¨Ø±Ù…Ø¬Ø© + Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ + Ø´Ø¨ÙƒØ§Øª + Ù…Ù‡Ù…Ø§Øª.",
  "url": "/",
  "sameAs": ["https://instagram.com/btec_zone.2_008"]
}
</script>

</body>
</html>
